#!/usr/bin/env bash
# notify-speak â€” Notification hook (async, fallback)
# Speaks the notification message with personality wrapper.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
PLUGIN_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

source "$PLUGIN_ROOT/scripts/detect-python.sh"

CONFIG_FILE="$PLUGIN_ROOT/config/voice-config.json"
PERSONALITIES_FILE="$PLUGIN_ROOT/config/personalities.json"

# Check if muted
if [ -f "$CONFIG_FILE" ]; then
    MUTED=$(cat "$CONFIG_FILE" | $PYTHON -c "import sys,json; print(json.load(sys.stdin).get('muted', False))" 2>/dev/null || echo "False")
    if [ "$MUTED" = "True" ] || [ "$MUTED" = "true" ]; then
        exit 0
    fi
fi

# Read hook input from stdin
INPUT=$(cat)

# Extract notification type and message
NOTIFICATION_TYPE=$(echo "$INPUT" | $PYTHON -c "
import sys, json
data = json.load(sys.stdin)
print(data.get('notification_type', ''))
" 2>/dev/null || echo "")

NOTIFICATION_MSG=$(echo "$INPUT" | $PYTHON -c "
import sys, json
data = json.load(sys.stdin)
print(data.get('message', ''))
" 2>/dev/null || echo "")

if [ -z "$NOTIFICATION_TYPE" ]; then
    exit 0
fi

# Get personality and pick a fallback message
PERSONALITY="casual"
if [ -f "$CONFIG_FILE" ]; then
    PERSONALITY=$(cat "$CONFIG_FILE" | $PYTHON -c "import sys,json; print(json.load(sys.stdin).get('personality', 'casual'))" 2>/dev/null || echo "casual")
fi

# Try to get a personality-specific fallback message
SPEAK_TEXT=""
if [ -f "$PERSONALITIES_FILE" ]; then
    SPEAK_TEXT=$(cat "$PERSONALITIES_FILE" | $PYTHON -c "
import sys, json, random
personalities = json.load(sys.stdin)
p = personalities.get('$PERSONALITY', personalities.get('casual', {}))
fallbacks = p.get('fallback_messages', {})
messages = fallbacks.get('$NOTIFICATION_TYPE', [])
if messages:
    print(random.choice(messages))
" 2>/dev/null || echo "")
fi

# If no personality fallback, use the system notification message
if [ -z "$SPEAK_TEXT" ]; then
    SPEAK_TEXT="$NOTIFICATION_MSG"
fi

if [ -z "$SPEAK_TEXT" ]; then
    exit 0
fi

# Read config for volume, rate, voice
VOLUME=100
RATE=2
VOICE=""
if [ -f "$CONFIG_FILE" ]; then
    eval "$(cat "$CONFIG_FILE" | $PYTHON -c "
import sys, json
c = json.load(sys.stdin)
print(f'VOLUME={c.get(\"volume\", 100)}')
print(f'RATE={c.get(\"rate\", 2)}')
v = c.get('voice', '') or ''
print(f'VOICE={v}')
" 2>/dev/null || echo "")"
fi

# Speak it
bash "$PLUGIN_ROOT/scripts/speak.sh" "$SPEAK_TEXT" "$VOLUME" "$RATE" "$VOICE"
